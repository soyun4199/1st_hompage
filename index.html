import React, { useState, useEffect } from "react";

/* ============================================
   0. ê³µí†µ ë ˆë²¨Â·XP ë³´ìƒ ì‹œìŠ¤í…œ
   ============================================ */
function useRewardSystem() {
  const [xp, setXp] = useState(0);
  const [level, setLevel] = useState(1);

  const addXp = (amount) => {
    setXp((prev) => prev + amount);
  };

  useEffect(() => {
    const newLevel = Math.floor(xp / 100) + 1;
    setLevel(newLevel);
  }, [xp]);

  return { xp, level, addXp };
}

/* ============================================
   1-1. ì˜¤ëŠ˜ì˜ ì‘ì€ ëª©í‘œ
   ============================================ */
function MicroGoalsSection({ addXp }) {
  const baseGoals = [
    "ë¬¼ í•œ ì»µ ë§ˆì‹œê¸°",
    "ì˜¤ëŠ˜ ê³µë¶€ 20ë¶„ë§Œ í•´ë³´ê¸°",
    "ë°© ì •ë¦¬ 5ë¶„ë§Œ í•˜ê¸°",
    "ë°–ì— ë‚˜ê°€ì„œ 5ë¶„ ì‚°ì±…í•˜ê¸°",
    "ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼ 3ê°œ ì ì–´ë³´ê¸°",
    "íœ´ëŒ€í° ë‚´ë ¤ë†“ê³  10ë¶„ ì§‘ì¤‘í•˜ê¸°",
  ];

  const [goals, setGoals] = useState(() =>
    baseGoals.slice(0, 3).map((t, i) => ({ id: i + 1, text: t, done: false }))
  );

  const handleToggle = (id) => {
    setGoals((prev) =>
      prev.map((g) => {
        if (g.id === id) {
          if (!g.done) addXp(15);
          return { ...g, done: !g.done };
        }
        return g;
      })
    );
  };

  const handleShuffle = () => {
    const shuffled = [...baseGoals].sort(() => Math.random() - 0.5);
    setGoals(
      shuffled.slice(0, 3).map((t, i) => ({
        id: i + 1,
        text: t,
        done: false,
      }))
    );
  };

  return (
    <div className="card">
      <h2>ğŸŒ± ì˜¤ëŠ˜ì˜ ì‘ì€ ëª©í‘œ</h2>
      <p className="sub">ì§€ê¸ˆ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” ì•„ì£¼ ì‘ì€ í–‰ë™ë¶€í„° ì‹œì‘í•´ë³´ëŠ” ê³µê°„ì…ë‹ˆë‹¤.</p>

      <ul className="goal-list">
        {goals.map((goal) => (
          <li key={goal.id} className="goal-item">
            <label>
              <input
                type="checkbox"
                checked={goal.done}
                onChange={() => handleToggle(goal.id)}
              />
              <span className={goal.done ? "goal-done" : ""}>
                {goal.text}
              </span>
            </label>
          </li>
        ))}
      </ul>

      <button onClick={handleShuffle}>ëª©í‘œ ë‹¤ì‹œ ë½‘ê¸°</button>
    </div>
  );
}

/* ============================================
   1-2. í™œë™ ê¸°ë¡(ì€ë‘”Â·ì‰¬ì—ˆìŒ ì„¸ëŒ€ ê°ì†Œ)
   ============================================ */
function ActivityTrackerSection({ addXp }) {
  const [activities, setActivities] = useState([
    { id: "study", label: "ê³µë¶€í•˜ê¸°", count: 0 },
    { id: "walk", label: "ì‚°ì±… / ì™¸ì¶œ", count: 0 },
    { id: "talk", label: "ëˆ„êµ°ê°€ì™€ ëŒ€í™”", count: 0 },
    { id: "stretch", label: "ìŠ¤íŠ¸ë ˆì¹­", count: 0 },
    { id: "care", label: "ìê¸° ê´€ë¦¬", count: 0 },
  ]);

  const handleClick = (id) => {
    setActivities((prev) =>
      prev.map((a) => (a.id === id ? { ...a, count: a.count + 1 } : a))
    );
    addXp(10);
  };

  return (
    <div className="card">
      <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ í™œë™ ê¸°ë¡</h2>
      <p className="sub">ì‘ì€ í–‰ë™ë„ ëˆˆì— ë³´ì´ë©´ ìì‹ ê°ì´ ìƒê²¨ìš”.</p>

      <div className="activity-buttons">
        {activities.map((a) => (
          <button key={a.id} onClick={() => handleClick(a.id)}>
            {a.label} +1
          </button>
        ))}
      </div>

      <ul>
        {activities.map((a) => (
          <li key={a.id}>
            {a.label}: {a.count}íšŒ
          </li>
        ))}
      </ul>
    </div>
  );
}
/* ============================================
   2-1. ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸
   ============================================ */
function PomodoroTimer({ onComplete }) {
  const [minutes, setMinutes] = useState(25);
  const [seconds, setSeconds] = useState(1500);
  const [running, setRunning] = useState(false);

  useEffect(() => {
    setSeconds(minutes * 60);
  }, [minutes]);

  useEffect(() => {
    if (!running) return;

    const timer = setInterval(() => {
      setSeconds((s) => {
        if (s <= 1) {
          clearInterval(timer);
          setRunning(false);
          onComplete();
          return 0;
        }
        return s - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [running]);

  const format = (t) =>
    `${String(Math.floor(t / 60)).padStart(2, "0")}:${String(t % 60).padStart(
      2,
      "0"
    )}`;

  return (
    <div className="card">
      <h2>â± ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸</h2>
      <p className="sub">25ë¶„ ì§‘ì¤‘ + 5ë¶„ íœ´ì‹ì„ ë°˜ë³µí•˜ëŠ” ê³µë¶€ë²•</p>

      <label>
        ë¶„ ì„¤ì •:
        <input
          type="number"
          min="1"
          value={minutes}
          onChange={(e) => setMinutes(Number(e.target.value))}
        />
      </label>

      <div className="timer-display">{format(seconds)}</div>

      <button onClick={() => setRunning(true)}>ì‹œì‘</button>
      <button onClick={() => setRunning(false)}>ì¼ì‹œì •ì§€</button>
      <button onClick={() => setSeconds(minutes * 60)}>ë¦¬ì…‹</button>
    </div>
  );
}

/* ============================================
   2-2. ê³µë¶€ ëŒ€ê²° ë°©
   ============================================ */
function StudyRooms({ pomodoroCount }) {
  const [room, setRoom] = useState(null);

  const rooms = [
    { id: 1, name: "ì•„ì¹¨ ê³µë¶€ë°©", avg: 3 },
    { id: 2, name: "ë°¤ìƒ˜ ì½”ë”©ë°©", avg: 6 },
    { id: 3, name: "ì€ë‘” íƒˆì¶œ ì±Œë¦°ì§€", avg: 2 },
  ];

  return (
    <div className="card">
      <h2>âš” ê³µë¶€ ëŒ€ê²° ë°©</h2>
      <p className="sub">ê²Œì„ì²˜ëŸ¼ ê²½ìŸí•˜ë©° ê³µë¶€í•  ìˆ˜ ìˆì–´ìš”.</p>

      <ul>
        {rooms.map((r) => (
          <li key={r.id} className="room-item">
            {r.name} (í‰ê·  {r.avg}íšŒ)
            {room === r.id ? (
              <span className="joined">âœ” ì°¸ì—¬ì¤‘</span>
            ) : (
              <button onClick={() => setRoom(r.id)}>ì…ì¥</button>
            )}
          </li>
        ))}
      </ul>

      {room && (
        <div className="inner-box">
          <h3>í˜„ì¬ ë‚˜ì˜ ê¸°ë¡</h3>
          ì˜¤ëŠ˜ ë½€ëª¨ë„ë¡œ ì™„ë£Œ: {pomodoroCount}íšŒ
        </div>
      )}
    </div>
  );
}

/* ============================================
   3-1. ì±—ë´‡ ëŒ€í™”
   ============================================ */
function ChatbotSection({ level }) {
  const [msgs, setMsgs] = useState([
    { from: "bot", text: "ì•ˆë…•! ì˜¤ëŠ˜ ëª©í‘œ í•˜ë‚˜ ì •í•´ë³¼ê¹Œ?" },
  ]);
  const [input, setInput] = useState("");

  const sendMessage = () => {
    if (!input.trim()) return;

    const userText = input.trim();
    const userMsg = { from: "user", text: userText };

    let reply = "ì¢‹ì•„! ì•„ì£¼ ì‘ì€ í–‰ë™ë¶€í„° ì‹œì‘í•´ë³´ì.";

    if (userText.includes("ë¶ˆì•ˆ") || userText.includes("ê±±ì •"))
      reply = "ë¶ˆì•ˆí•  ë• ì‘ì€ ëª©í‘œ 1ê°œë§Œ ì‹¤í–‰í•´ë³´ëŠ” ê²Œ ì¢‹ì•„.";
    if (userText.includes("ê·€ì°®") || userText.includes("í•˜ê¸° ì‹«"))
      reply = "ê·¸ëŸ´ ë• 5ë¶„ë§Œ í•´ë³´ê¸°! ë”± 5ë¶„ë§Œ í•˜ê³  ë©ˆì¶°ë„ ë¼.";
    if (userText.includes("ì€ë‘”") || userText.includes("ì‚¬ëŒ"))
      reply = "ë¨¼ì € ìµëª… ëŒ€í™”ë¶€í„° ì‹œë„í•´ë³´ëŠ” ê±´ ì–´ë•Œ? ë¶€ë‹´ì´ ì ì–´.";

    setMsgs((prev) => [...prev, userMsg, { from: "bot", text: reply }]);
    setInput("");
  };

  return (
    <div className="card">
      <h2>ğŸ¤– ë‹¨ê³„ 1: ì±—ë´‡ê³¼ ëŒ€í™”í•˜ê¸°</h2>
      <p className="sub">ë ˆë²¨ {level} ì´ìƒ ì‚¬ìš© ê°€ëŠ¥</p>

      <div className="chat-box">
        {msgs.map((m, i) => (
          <div key={i} className={m.from === "bot" ? "bot-msg" : "user-msg"}>
            {m.text}
          </div>
        ))}
      </div>

      <input
        value={input}
        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={(e) => e.key === "Enter" && sendMessage()}
      />
      <button onClick={sendMessage}>ì „ì†¡</button>
    </div>
  );
}
/* ============================================
   3-2. ìµëª… í•œì¤„ ì±„íŒ…
   ============================================ */
function AnonymousChatSection({ level }) {
  const [msgs, setMsgs] = useState([
    { nick: "ìµëª…1", text: "ì˜¤ëŠ˜ ì‚°ì±… ì„±ê³µí–ˆì–´ìš”!" },
    { nick: "ìµëª…2", text: "ë“œë””ì–´ ê³µë¶€ ì‹œì‘í–ˆìŠµë‹ˆë‹¤ ğŸ”¥" },
  ]);
  const [input, setInput] = useState("");

  // ë ˆë²¨ 2 ë¯¸ë§Œì´ë©´ ì ê¸ˆ í‘œì‹œ
  if (level < 2)
    return (
      <div className="card card-locked">
        <h2>ğŸ”’ ë‹¨ê³„ 2: ìµëª… í•œì¤„ ëŒ€í™”</h2>
        <p>ë ˆë²¨ 2ë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>
    );

  const send = () => {
    if (!input.trim()) return;
    setMsgs((prev) => [...prev, { nick: "ë‚˜(ìµëª…)", text: input }]);
    setInput("");
  };

  return (
    <div className="card">
      <h2>ğŸ—£ ë‹¨ê³„ 2: ìµëª… í•œì¤„ ëŒ€í™”</h2>
      <p className="sub">ì§§ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ ê°€ë³ê²Œ ì†Œí†µí•´ë³´ì„¸ìš”.</p>

      <div className="chat-box">
        {msgs.map((m, i) => (
          <div key={i} className="anon-msg">
            <b>{m.nick}:</b> {m.text}
          </div>
        ))}
      </div>

      <input
        value={input}
        placeholder="í•œ ë¬¸ì¥ ë‚¨ê²¨ë³´ì„¸ìš”..."
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={(e) => e.key === "Enter" && send()}
      />
      <button onClick={send}>ì „ì†¡</button>
    </div>
  );
}

/* ============================================
   3-3. í†µí™”(ìŒì„±Â·ì˜ìƒ) UI ë°ëª¨
   ============================================ */
function CallSection({ level }) {
  // ë ˆë²¨ 3 ë¯¸ë§Œ ì ê¸ˆ
  if (level < 3)
    return (
      <div className="card card-locked">
        <h2>ğŸ”’ ë‹¨ê³„ 3: ìŒì„±Â·ì˜ìƒ í†µí™”</h2>
        <p>ë ˆë²¨ 3ë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>
    );

  return (
    <div className="card">
      <h2>ğŸ“ ë‹¨ê³„ 3: ìŒì„±Â·ì˜ìƒ í†µí™” (ë°ëª¨)</h2>
      <p className="sub">ì‹¤ì œ ì—°ê²° ê¸°ëŠ¥ì€ ì—†ê³ , UI í˜•íƒœë§Œ êµ¬í˜„ëœ ë°ëª¨ í™”ë©´ì…ë‹ˆë‹¤.</p>

      <div className="inner-box">
        <h3>ğŸ¤ ìŒì„± í†µí™”</h3>
        <button>ìŒì„± í†µí™” ìš”ì²­í•˜ê¸° (ë°ëª¨)</button>
      </div>

      <div className="inner-box">
        <h3>ğŸ“¹ ì˜ìƒ í†µí™” + ì–¼êµ´ ìŠ¤í‹°ì»¤</h3>
        <div className="fake-video">
          ğŸ˜€ <span className="sticker">ğŸ¦Š ìŠ¤í‹°ì»¤ ì ìš©ë¨</span>
        </div>
        <button>ì˜ìƒ í†µí™” ì‹œì‘ (ë°ëª¨)</button>
      </div>
    </div>
  );
}
/* ============================================
   ë³´ìƒÂ·ë ˆë²¨ UI
   ============================================ */
function RewardStatus({ xp, level, pomodoroCount }) {
  return (
    <div className="card">
      <h2>ğŸ® ë‚˜ì˜ ë ˆë²¨ & ë³´ìƒ</h2>
      <p>í˜„ì¬ ë ˆë²¨: <b>{level}</b></p>
      <p>ì´ ê²½í—˜ì¹˜: {xp} XP</p>
      <p>ì˜¤ëŠ˜ ë½€ëª¨ë„ë¡œ ì™„ë£Œ: {pomodoroCount}íšŒ</p>

      <ul className="sub-list">
        <li>Lv.1 â†’ ì±—ë´‡ ì‚¬ìš© ê°€ëŠ¥</li>
        <li>Lv.2 â†’ ìµëª… ëŒ€í™” í•´ê¸ˆ</li>
        <li>Lv.3 â†’ ìŒì„±Â·ì˜ìƒ í†µí™” í•´ê¸ˆ</li>
      </ul>
    </div>
  );
}

/* ============================================
   ë©”ì¸ App
   ============================================ */
function App() {
  const { xp, level, addXp } = useRewardSystem();
  const [pomodoroCount, setPomodoroCount] = useState(0);

  const onPomodoroDone = () => {
    setPomodoroCount((prev) => prev + 1);
    addXp(50);
    alert("ğŸ‰ ë½€ëª¨ë„ë¡œ 1ì„¸ì…˜ ì™„ë£Œ! XP +50");
  };

  return (
    <div className="app">
      <h1>ActiLink â€“ ê³µë¶€ ì˜ì§€ & ì‚¬íšŒì  ì—°ê²° íšŒë³µ ì•±</h1>
      <p className="intro">ì‘ì€ í–‰ë™ë¶€í„° ì‹œì‘í•´ë³´ëŠ” ì„±ì¥ ì•±</p>

      <div className="grid">
        <RewardStatus xp={xp} level={level} pomodoroCount={pomodoroCount} />
        <MicroGoalsSection addXp={addXp} />
        <ActivityTrackerSection addXp={addXp} />
        <PomodoroTimer onComplete={onPomodoroDone} />
        <StudyRooms pomodoroCount={pomodoroCount} />
        <ChatbotSection level={level} />
        <AnonymousChatSection level={level} />
        <CallSection level={level} />
      </div>

      {/* ===== ìŠ¤íƒ€ì¼ ===== */}
      <style>{`
        body { margin: 0; background: #0f172a; color: white; font-family: Arial, sans-serif; }
        .app { padding: 20px; max-width: 1200px; margin: auto; }
        h1 { text-align: center; margin-bottom: 10px; }
        .intro { text-align: center; margin-bottom: 20px; opacity: 0.8; }

        .grid {
          display: grid;
          gap: 16px;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .card {
          background: #1e293b;
          padding: 16px;
          border-radius: 12px;
          box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        .card-locked {
          opacity: 0.5;
          pointer-events: none;
        }

        button {
          margin-top: 6px;
          padding: 8px 12px;
          border: none;
          border-radius: 8px;
          background: #2563eb;
          color: white;
          cursor: pointer;
        }
        button:hover { background: #1d4ed8; }

        input {
          padding: 6px;
          border-radius: 6px;
          border: none;
          margin-top: 4px;
        }

        .goal-done { text-decoration: line-through; color: #22c55e; }

        .timer-display {
          font-size: 2rem;
          text-align: center;
          margin: 12px 0;
        }

        .chat-box {
          background: #0f172a;
          padding: 10px;
          height: 150px;
          overflow-y: auto;
          border-radius: 8px;
          margin-bottom: 8px;
        }

        .bot-msg { background: #334155; padding: 6px; border-radius: 6px; margin-bottom: 6px; }
        .user-msg { background: #4b5563; padding: 6px; border-radius: 6px; margin-bottom: 6px; text-align: right; }

        .inner-box {
          margin-top: 10px;
          padding: 10px;
          background: #0f172a;
          border-radius: 8px;
        }

        .fake-video {
          background: #334155;
          padding: 20px;
          border-radius: 8px;
          margin: 10px 0;
          text-align: center;
          font-size: 1.3rem;
        }

        .sticker {
          background: #fbbf24;
          padding: 2px 6px;
          border-radius: 6px;
          margin-left: 6px;
        }
      `}</style>
    </div>
  );
}

export default App;
